<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CS Majors — Picks vs Win Rate</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: white;
      color: black;
      padding: 8px;
    }
    header {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 4px;
    }
    h1 {
      margin: 0;
      font-size: 1rem;
      flex: 1;
    }
    #chart {
      width: 100%;
      height: 75vh;
      min-height: 400px;
    }
    .hint {
      color: #555;
      font-size: 0.9rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>CS Majors — Maps Picked vs Win Rate</h1>
    <input id="file" type="file" accept=".csv" title="Upload CSV" />
    <input id="search" type="text" placeholder="Search team" title="Search team" />
  </header>

  <div id="chart"></div>
  <div class="hint">
    Tip: Zoom with Drag, double click to go back.
  </div>

<script>
function parseNumber(v){
  if (v === null || v === undefined) return NaN;
  let s = String(v).trim();
  if (s === '') return NaN;
  s = s.replace('%','').replace(/\s+/g,'').replace(',', '.');
  let n = parseFloat(s);
  if (isNaN(n)) return NaN;
  if (n <= 1.0) n = n * 100;
  return n;
}
function parseIntSafe(v){
  if (v === null || v === undefined) return NaN;
  let s = String(v).trim().replace(/\s+/g,'').replace(',','.');
  let n = Number(s);
  return isNaN(n) ? NaN : Math.round(n);
}
function getField(obj, candidates){
  for (let k of Object.keys(obj)){
    let kn = k.toLowerCase().replace(/[_\s]/g,'');
    for (let cand of candidates){
      let c = cand.toLowerCase().replace(/[_\s]/g,'');
      if (kn === c) return obj[k];
    }
  }
  return undefined;
}

let rawData = [];
const chartEl = document.getElementById('chart');
const fileInput = document.getElementById('file');
const searchInput = document.getElementById('search');

function processRows(rows){
  const parsed = [];
  for (let r of rows){
    if (Object.keys(r).length === 0) continue;
    let teamV = getField(r, ['Team','team']);
    let mapsV = getField(r, ['MapsPicked','Maps','maps']);
    let winV = getField(r, ['WinRate','Winrate','Win%']);
    let team = String(teamV).trim();
    if (!team) continue;
    let maps = parseIntSafe(mapsV);
    if (isNaN(maps)) maps = 0;
    let win = parseNumber(winV);
    if (isNaN(win)) win = null;
    parsed.push({ team, maps, win });
  }
  rawData = parsed;
  drawPlot();
}

function arcPath(cx, cy, r, startAngle, endAngle){
  const rad = Math.PI / 180;
  const x1 = cx + r * Math.cos(startAngle * rad);
  const y1 = cy + r * Math.sin(startAngle * rad);
  const x2 = cx + r * Math.cos(endAngle * rad);
  const y2 = cy + r * Math.sin(endAngle * rad);
  const largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;
  return `M ${cx},${cy} L ${x1},${y1} A ${r},${r} 0 ${largeArcFlag} 1 ${x2},${y2} Z`;
}

function drawPlot(){
  if (!rawData || rawData.length === 0) {
    chartEl.innerHTML = '<div style="padding:16px;color:#666">No data loaded.</div>';
    return;
  }
  const names = rawData.map(d => d.team);
  const xs = rawData.map(d => d.maps);
  const ys = rawData.map(d => d.win === null ? NaN : d.win);
  const hoverTexts = rawData.map(d => `${d.team}<br>Maps: ${d.maps}<br>Win Rate: ${ (d.win === null ? '—' : d.win.toFixed(2) + '%') }`);

  const trace = {
    x: xs,
    y: ys,
    mode: 'markers',
    type: 'scatter',
    text: hoverTexts,
    hovertemplate: '<b>%{text}</b><extra></extra>',
    marker: {
      size: 9,
      color: 'black'
    },
    customdata: names
  };

  const maxR = Math.max(Math.max(...xs), Math.max(...ys));
  const layout = {
    margin: { t: 40, r: 20, b: 60, l: 60 },
    xaxis: { title: 'Maps picked', range: [0, maxR], zeroline: false, gridcolor: '#eee' },
    yaxis: { title: 'Win Rate (%)', range: [0, maxR], gridcolor: '#eee' },
    hovermode: 'closest',
    paper_bgcolor: 'transparent',
    plot_bgcolor: 'transparent',
    shapes: [
      { // Rot
        type: 'path',
        path: arcPath(0,0, maxR, 90, 0),
        fillcolor: 'rgba(255,100,100,0.4)',
        line: {width: 0},
        xref: 'x', yref: 'y'
      },
      { // Gelb
        type: 'path',
        path: arcPath(0,0, maxR*0.66, 90, 0),
        fillcolor: 'rgba(255,255,150,0.6)',
        line: {width: 0},
        xref: 'x', yref: 'y'
      },
      { // Grün
        type: 'path',
        path: arcPath(0,0, maxR*0.33, 90, 0),
        fillcolor: 'rgba(150,255,150,0.6)',
        line: {width: 0},
        xref: 'x', yref: 'y'
      }
    ]
  };

  Plotly.newPlot(chartEl, [trace], layout, { responsive: true, displaylogo: false });
}

function loadCSVFromURL(url='./data.csv'){
  fetch(url).then(r=>{
    if (!r.ok) throw new Error('not found');
    return r.text();
  }).then(txt => {
    Papa.parse(txt, { header: true, skipEmptyLines: true, complete: res => processRows(res.data) });
  }).catch(() => {
    chartEl.innerHTML = '<div style="padding:14px;color:#666">No CSV loaded. Upload manually.</div>';
  });
}

fileInput.addEventListener('change', ev=>{
  const f = ev.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = () => {
    Papa.parse(r.result, { header: true, skipEmptyLines: true, complete: res => processRows(res.data) });
  };
  r.readAsText(f);
});

searchInput.addEventListener('input', ()=>{
  const query = searchInput.value.trim().toLowerCase();
  if (!query){
    drawPlot();
    return;
  }
  const idx = rawData.findIndex(d => d.team.toLowerCase().includes(query));
  if (idx !== -1){
    const colors = rawData.map((_,i) => i===idx ? 'red' : 'black');
    Plotly.restyle(chartEl, {'marker.color': [colors]});
  }
});

loadCSVFromURL();
</script>
</body>
</html>
